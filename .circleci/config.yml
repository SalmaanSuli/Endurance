version: 2.1

# Orb declarations --
orbs:
  codecov: codecov/codecov@3.2.4
  
jobs:     
  build:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout

      - run: 
          command: sudo apt-get update
          name: Downloading latest version of my app
          
      - run: 
          command: flutter doctor
          name: Checking the environment
      
      - run: 
          command: flutter pub get
          name: Getting all dependencies
      
      - run:
          name: Make folder for test results
          command: mkdir -p test-results/dart-tests
      
      - run: 
          command: flutter test --coverage
          name: Run Unit Test
          
      - run: 
          command: flutter test --coverage
          name: Run Test coverage
          
      - store_test_results:
          path: test-results
          
      - codecov/upload:
         file: coverage/lcov.info
         
      - name: Upload coverage reports to Codecov
          run: |
            # Replace `linux` below with the appropriate OS
            # Options are `alpine`, `linux`, `macos`, `windows`
            curl -Os https://uploader.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov -t ${CODECOV_TOKEN}
            cat codecov.yml | curl --data-binary @- https://codecov.io/validate
         
        
